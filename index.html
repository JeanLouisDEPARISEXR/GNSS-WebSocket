<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>GNSS Live Position (Leaflet + WebSocket, Multi-Receivers)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
    <style>
      html, body { height: 100%; margin: 0; background: #0b0b0c; color: #eaeaea; }
      #app { height: 100%; display: grid; grid-template-rows: auto 1fr; }
      header { padding: 10px 14px; display: flex; gap: 12px; align-items: center; border-bottom: 1px solid #232327; }
      .dot { width:10px; height:10px; border-radius:50%; background:#ff5555; box-shadow:0 0 8px #ff5555aa; }
      .dot.ok { background:#50fa7b; box-shadow:0 0 8px #50fa7baa; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      .panel { display:flex; gap:18px; flex-wrap:wrap; align-items:baseline; font-size:14px; }
      .panel strong { color: #fafafa; }
      #map { height: 100%; }

      /* -------- Custom tools control -------- */
      .leaflet-control-custom { background: transparent; }
      .tools-box {
        background:#1c1c21; color:#eaeaea;
        border:1px solid #2a2a2f; border-radius:8px;
        box-shadow:0 1px 3px rgba(0,0,0,.35);
        overflow:hidden; min-width: 180px;
      }
      .tools-box .section { padding: 8px 12px; border-bottom:1px solid #2a2a2f; }
      .tools-box .section:last-child { border-bottom: 0; }
      .tools-box button {
        width: 100%;
        display:flex; align-items:center; gap:8px;
        padding:8px 12px; background:transparent; color:#eaeaea;
        border:0; border-top:1px solid #2a2a2f;
        font: 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        cursor:pointer; text-align:left;
      }
      .tools-box button:first-of-type { border-top: 0; }
      .tools-box button:hover { background:#24242b; }
      .tools-box .state { margin-left:auto; opacity:.9; }
      .tools-box .active { outline:2px solid #50fa7b66; outline-offset:-2px; border-radius:6px; }
      .tools-box select {
        width: 100%; margin-top: 6px;
        background:#16161a; color:#eaeaea; border:1px solid #2a2a2f; border-radius:6px;
        padding:6px 8px; font-size:13px;
      }
      .legend { display:flex; flex-direction:column; gap:6px; margin-top:8px; font-size:12px; opacity:.9; }
      .legend-item { display:flex; align-items:center; gap:8px; }
      .chip { width:12px; height:12px; border-radius:50%; border:2px solid currentColor; }
    </style>
  </head>
  <body>
    <div id="app">
      <header>
        <div id="statusDot" class="dot" title="WebSocket status"></div>
        <div class="panel">
          <div><strong>WS:</strong> <span id="wsUrl" class="mono"></span></div>
          <div><strong>Fix:</strong> <span id="fixQ">—</span></div>
          <div><strong>Sats:</strong> <span id="sats">—</span></div>
          <div><strong>HDOP:</strong> <span id="hdop">—</span></div>
          <div><strong>Alt:</strong> <span id="alt">—</span> m</div>
          <div><strong>UTC:</strong> <span id="utc">—</span></div>
        </div>
      </header>
      <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
    <script>
      const WS_URL = 'ws://127.0.0.1:8765';
      document.getElementById('wsUrl').textContent = WS_URL;

      // --- Base layers
      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 26, maxNativeZoom: 19, attribution: '&copy; OpenStreetMap contributors'
      });
      const esriSat = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          maxZoom: 26, attribution: 'Tiles &copy; Esri'
        }
      );
      const tonerLite = L.tileLayer(
        'https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {
          maxZoom: 26, maxNativeZoom: 20, attribution: 'Tiles by <a href="http://stamen.com">Stamen</a>'
        }
      );

      const map = L.map('map', { layers: [osm] }).setView([48.8566, 2.3522], 13);
      L.control.layers({ "OSM": osm, "Satellite": esriSat, "Toner Lite": tonerLite }, {}, { position: 'topleft' }).addTo(map);

      const palette = ['#4CAF50','#1E90FF','#FF9800','#E91E63','#9C27B0','#00BCD4','#FFC107','#8BC34A'];
      const devices = new Map();
      let firstFix = true, follow = false, userPanned = false, activeSource = null;

      // --- Custom Tools Panel ---
      const ToolsControl = L.Control.extend({
        options: { position: 'topleft' },
        onAdd: function() {
          const wrapper = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
          const box = L.DomUtil.create('div', 'tools-box', wrapper);

          // Device selector
          const secSel = L.DomUtil.create('div', 'section', box);
          secSel.innerHTML = `<div style="opacity:.8">Device</div>`;
          const sel = L.DomUtil.create('select', '', secSel);
          sel.id = 'deviceSelect';
          sel.addEventListener('change', () => { activeSource = sel.value || null; });

          // Actions
          const secAct = L.DomUtil.create('div', 'section', box);
          const bCenter = L.DomUtil.create('button', '', secAct); bCenter.textContent = 'Center';
          const bFollow = L.DomUtil.create('button', '', secAct); bFollow.id = 'btnFollow'; bFollow.innerHTML = `<span>Follow</span><span class="state" id="followState">OFF</span>`;
          const bClear = L.DomUtil.create('button', '', secAct); bClear.textContent = 'Clear Path';

          L.DomEvent.disableClickPropagation(wrapper);
          L.DomEvent.on(bCenter,'click',(e)=>{L.DomEvent.preventDefault(e);centerOnActive();});
          L.DomEvent.on(bFollow,'click',(e)=>{L.DomEvent.preventDefault(e);setFollow(!follow);});
          L.DomEvent.on(bClear,'click',(e)=>{L.DomEvent.preventDefault(e);clearPaths();});

          // Legend
          const secLegend = L.DomUtil.create('div', 'section', box);
          secLegend.innerHTML = '<div style="opacity:.8">Legend</div><div class="legend" id="legendList"></div>';

          return wrapper;
        }
      });
      map.addControl(new ToolsControl());

      // Header bindings
      const $fixQ=document.getElementById('fixQ'),$sats=document.getElementById('sats'),
            $hdop=document.getElementById('hdop'),$alt=document.getElementById('alt'),
            $utc=document.getElementById('utc'),$dot=document.getElementById('statusDot');
      function setOnline(on){$dot.classList.toggle('ok',!!on);}
      function updateStats(d){
        $fixQ.textContent=d.fix_quality??'0';
        $sats.textContent=d.num_sats??'0';
        $hdop.textContent=d.hdop??'—';
        $alt.textContent=d.alt_m??'—';
        $utc.textContent=d.timestamp_utc??'—';
      }

      // Devices management
      function ensureDevice(source){
        if(devices.has(source)) return devices.get(source);
        const color=palette[devices.size%palette.length];
        const state={color,marker:null,circle:null,track:L.polyline([], {weight:3,color}).addTo(map),last:null};
        devices.set(source,state);

        const sel=document.getElementById('deviceSelect');
        if(sel && ![...sel.options].some(o=>o.value===source)){
          const opt=document.createElement('option'); opt.value=source; opt.textContent=source;
          sel.appendChild(opt);
          if(!activeSource){activeSource=source; sel.value=source;}
        }
        const list=document.getElementById('legendList');
        if(list && !document.getElementById('legend_'+source)){
          const row=document.createElement('div'); row.className='legend-item'; row.id='legend_'+source;
          const chip=document.createElement('span'); chip.className='chip'; chip.style.color=color;
          const text=document.createElement('span'); text.textContent=source;
          row.appendChild(chip); row.appendChild(text); list.appendChild(row);
        }
        return state;
      }

      function setFollow(on){
        follow=!!on;
        const btn=document.getElementById('btnFollow'); const state=document.getElementById('followState');
        if(btn) btn.classList.toggle('active',follow);
        if(state) state.textContent=follow?'ON':'OFF';
        if(follow && activeSource && devices.get(activeSource)?.last){
          map.setView(devices.get(activeSource).last,Math.max(map.getZoom(),20)); userPanned=false;
        }
      }
      function centerOnActive(){
        if(!activeSource) return; const d=devices.get(activeSource);
        if(d?.last){map.setView(d.last,Math.max(map.getZoom(),20));userPanned=false;}
      }
      function clearPaths(){
        devices.forEach((dev)=>{
          dev.track.setLatLngs([]); // clear polyline
        });
      }

      function updatePositionFor(source,lat,lon,hdop){
        const dev=ensureDevice(source); const latlng=[lat,lon]; dev.last=latlng;
        const radius=typeof hdop==='number'?Math.max(1,hdop*5):5;
        if(!dev.marker){dev.marker=L.circleMarker(latlng,{radius:6,weight:2,color:dev.color,fillOpacity:0.7}).addTo(map);}else dev.marker.setLatLng(latlng);
        if(!dev.circle){dev.circle=L.circle(latlng,{radius,color:dev.color,opacity:0.35}).addTo(map);}else dev.circle.setLatLng(latlng).setRadius(radius);
        dev.track.addLatLng(latlng);
        if(firstFix){map.setView(latlng,20);firstFix=false;userPanned=false;}
        else if(follow && activeSource===source && !userPanned) map.panTo(latlng,{animate:true});
      }

      map.on('dragstart zoomstart',()=>{userPanned=true;});

      // WebSocket client
      let ws,retry=0;
      function connect(){
        ws=new WebSocket(WS_URL);
        ws.onopen=()=>{setOnline(true);retry=0;};
        ws.onclose=()=>{setOnline(false);setTimeout(connect,Math.min(10000,500*Math.pow(2,retry++)));};
        ws.onerror=()=>{try{ws.close();}catch{}};
        ws.onmessage=(e)=>{
          try{
            const d=JSON.parse(e.data);
            if(d.type==='gga'){
              updateStats(d); const src=d.source||'dev';
              if(typeof d.lat==='number'&&typeof d.lon==='number') updatePositionFor(src,d.lat,d.lon,d.hdop);
            }
          }catch{}
        };
      } connect();

      // Keyboard shortcuts
      window.addEventListener('keydown',(e)=>{
        if(e.key.toLowerCase()==='c') centerOnActive();
        if(e.key.toLowerCase()==='f') setFollow(!follow);
      });
    </script>
  </body>
</html>
